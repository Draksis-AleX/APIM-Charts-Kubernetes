[SERVICE]
   Flush         1
   Log_Level     info
   Daemon        off
   Parsers_File  parsers.conf
   HTTP_Server   On
   HTTP_Listen   0.0.0.0
   HTTP_Port     2020

# Input from Ballerina log files
[INPUT]
   Name              tail
   Path              /ballerina-logs/app.log
   Parser            bal_logfmt_parser
   Tag               ballerina.*
   Refresh_Interval  5
   Mem_Buf_Limit     256MB
   Skip_Long_Lines   On
   Read_from_Head    On
   Path_Key          log_file_path

# Add application name from file path
[FILTER]
   Name    lua
   Match   *
   Script  /fluent-bit/etc/scripts.lua
   Call    extract_app_from_path

# ========== BALLERINA LOG PROCESSING ==========

# Enrich all Ballerina logs with common fields
[FILTER]
   Name    lua
   Match   ballerina.*
   Script  /fluent-bit/etc/scripts.lua
   Call    enrich_bal_logs

# Construct Ballerina app names
[FILTER]
   Name    lua
   Match   ballerina.*
   Script  /fluent-bit/etc/scripts.lua
   Call    construct_bal_app_name

# First: Separate Ballerina metrics logs (those with logger="metrics")
[FILTER]
   Name rewrite_tag
   Match ballerina.*
   Rule $logger ^metrics$ ballerina_metrics false
   Emitter_Name re_emitted_bal_metrics

# Second: Route remaining ballerina logs to application logs
# This catches all ballerina.* logs that weren't retagged as metrics
[FILTER]
   Name rewrite_tag
   Match ballerina.*
   Rule $module .* ballerina_app_logs false
   Emitter_Name re_emitted_bal_app_logs

# Process Ballerina metrics
[FILTER]
   Name    lua
   Match   ballerina_metrics
   Script  /fluent-bit/etc/scripts.lua
   Call    extract_bal_metrics_data

# ========== OUTPUT CONFIGURATIONS ==========

# Ballerina Application Logs
[OUTPUT]
   Name opensearch
   Host opensearch
   HTTP_User admin
   HTTP_Passwd ${OPENSEARCH_INITIAL_ADMIN_PASSWORD}
   Logstash_Format On
   Logstash_DateFormat %Y-%m-%d
   Logstash_Prefix ballerina-application-logs
   Match ballerina_app_logs
   Port 9200
   Replace_Dots On
   Suppress_Type_Name On
   tls Off
   tls.verify Off
   Trace_Error On

# Ballerina Metrics Logs
[OUTPUT]
   Name opensearch
   Host opensearch
   HTTP_User admin
   HTTP_Passwd ${OPENSEARCH_INITIAL_ADMIN_PASSWORD}
   Logstash_Format On
   Logstash_DateFormat %Y-%m-%d
   Logstash_Prefix ballerina-metrics-logs
   Match ballerina_metrics
   Port 9200
   Replace_Dots On
   Suppress_Type_Name On
   tls Off
   tls.verify Off
   Trace_Error On

# Fallback for any unmatched logs
[OUTPUT]
   Name opensearch
   Host opensearch
   HTTP_User admin
   HTTP_Passwd ${OPENSEARCH_INITIAL_ADMIN_PASSWORD}
   Logstash_Format On
   Logstash_DateFormat %Y-%m-%d
   Logstash_Prefix general-logs
   Match_regex ^(wso2mi|wso2apim).*
   Port 9200
   Replace_Dots On
   Suppress_Type_Name On
   tls Off
   tls.verify Off
   Trace_Error On
